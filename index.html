<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è¨˜å¸³App">
    <title>è¨˜å¸³App</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='20'/><text x='50' y='70' text-anchor='middle' font-size='60' fill='white'>ğŸ’°</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --success: #10b981; --danger: #ef4444; --bg: #0f172a; --bg-card: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 24px 20px; border-radius: 0 0 32px 32px; margin: -16px -16px 24px -16px; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); }
        .stat-value { font-size: 24px; font-weight: 900; font-family: 'JetBrains Mono', monospace; }
        .type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .type-btn { padding: 12px; border: 2px solid var(--border); background: transparent; color: var(--text); border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; }
        .type-btn.active { background: var(--primary); border-color: var(--primary); }
        .type-btn.expense.active { background: var(--danger); border-color: var(--danger); }
        .type-btn.income.active { background: var(--success); border-color: var(--success); }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border); background: var(--bg); color: var(--text); border-radius: 12px; margin-bottom: 12px; font-size: 16px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; background: var(--primary); color: white; font-size: 18px; }
        .transaction-item { background: var(--bg-card); padding: 16px; border-radius: 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid var(--primary); }
        .transaction-item.income { border-left-color: var(--success); }
        .transaction-item.expense { border-left-color: var(--danger); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); }
        .nav-item { color: var(--text-muted); text-decoration: none; font-size: 12px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .page { display: none; }
        .page.active { display: block; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="app">
        <div id="homePage" class="page active">
            <div class="container">
                <header>
                    <h1 id="currentMonth">2024å¹´ 3æœˆ</h1>
                    <div style="opacity: 0.8;">å€‹äººç†è²¡è¨˜å¸³æœ¬</div>
                </header>
                <div class="stats">
                    <div class="stat-card"><div style="color: var(--success);">æœ¬æœˆæ”¶å…¥</div><div class="stat-value" id="monthlyIncome">NT$ 0</div></div>
                    <div class="stat-card"><div style="color: var(--danger);">æœ¬æœˆæ”¯å‡º</div><div class="stat-value" id="monthlyExpense">NT$ 0</div></div>
                </div>
                <button class="btn" onclick="openModal()" style="margin-bottom: 24px;">â• æ–°å¢äº¤æ˜“</button>
                <div id="todayTransactions"></div>
            </div>
        </div>

        <div id="balancePage" class="page">
            <div class="container">
                <header><h1>ğŸ’µ å¸³æˆ¶é¤˜é¡</h1></header>
                <div id="accountList"></div>
            </div>
        </div>

        <div id="addModal" class="modal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h2>æ–°å¢æ˜ç´°</h2>
                    <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
                </div>
                <div class="type-selector">
                    <button class="type-btn expense active" onclick="setType('æ”¯å‡º', this)">æ”¯å‡º</button>
                    <button class="type-btn income" onclick="setType('æ”¶å…¥', this)">æ”¶å…¥</button>
                    <button class="type-btn" onclick="setType('è½‰å¸³', this)">è½‰å¸³</button>
                </div>
                <input type="date" id="date">
                <input type="number" id="amount" placeholder="é‡‘é¡">
                <select id="account"><option value="">é¸æ“‡å¸³æˆ¶</option></select>
                <select id="accountTo" style="display:none;"><option value="">è½‰å…¥å¸³æˆ¶</option></select>
                <select id="category" onchange="updateSubcategories()"><option value="">é¸æ“‡åˆ†é¡</option></select>
                <select id="subcategory"><option value="">é¸æ“‡å­åˆ†é¡</option></select>
                <input type="text" id="description" placeholder="å‚™è¨»">
                <button class="btn" onclick="addTransaction()">ç¢ºèªå„²å­˜</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <a class="nav-item active" onclick="showPage('homePage', this)">é¦–é </a>
            <a class="nav-item" onclick="showPage('balancePage', this)">é¤˜é¡</a>
        </nav>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyN-1_WrtI4K96z4buD-_OfS2QemIdLF3lnMTt2SPEuVo_GYCBMSSL42kSAB43aAa2z9A/exec';
        
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let config = JSON.parse(localStorage.getItem('config')) || { categories: {}, subcategories: {}, accounts: [] };
        let currentType = 'æ”¯å‡º';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            syncData();
            updateUI();
        });

        function showPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navEl.classList.add('active');
        }

        function openModal() { document.getElementById('addModal').classList.add('show'); updateDropdowns(); }
        function closeModal() { document.getElementById('addModal').classList.remove('show'); }

        function setType(type, btn) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('accountTo').style.display = type === 'è½‰å¸³' ? 'block' : 'none';
            document.getElementById('category').style.display = type === 'è½‰å¸³' ? 'none' : 'block';
            document.getElementById('subcategory').style.display = type === 'è½‰å¸³' ? 'none' : 'block';
            updateDropdowns();
        }

        function updateDropdowns() {
            const accSelect = document.getElementById('account');
            const accToSelect = document.getElementById('accountTo');
            const catSelect = document.getElementById('category');
            accSelect.innerHTML = '<option value="">é¸æ“‡å¸³æˆ¶</option>';
            accToSelect.innerHTML = '<option value="">è½‰å…¥å¸³æˆ¶</option>';
            config.accounts.forEach(acc => {
                accSelect.innerHTML += `<option value="${acc}">${acc}</option>`;
                accToSelect.innerHTML += `<option value="${acc}">${acc}</option>`;
            });
            catSelect.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>';
            if (config.categories[currentType]) {
                config.categories[currentType].forEach(cat => { catSelect.innerHTML += `<option value="${cat}">${cat}</option>`; });
            }
        }

        function updateSubcategories() {
            const cat = document.getElementById('category').value;
            const subSelect = document.getElementById('subcategory');
            subSelect.innerHTML = '<option value="">é¸æ“‡å­åˆ†é¡</option>';
            if (config.subcategories[cat]) {
                config.subcategories[cat].forEach(sub => { subSelect.innerHTML += `<option value="${sub}">${sub}</option>`; });
            }
        }

        async function syncData() {
            if (!SCRIPT_URL) return;
            try {
                const response = await fetch(SCRIPT_URL + '?action=getData');
                const data = await response.json();
                if (data.success) {
                    transactions = data.transactions;
                    config = data.config;
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('config', JSON.stringify(config));
                    updateUI();
                }
            } catch (e) { console.error('åŒæ­¥å¤±æ•—', e); }
        }

        async function addTransaction() {
            const val = parseFloat(document.getElementById('amount').value);
            const transaction = {
                date: document.getElementById('date').value,
                amount: val,        // è½‰å‡ºé‡‘é¡
                amountTo: val,      // åœ¨ App ä¸­æ–°å¢æ™‚ï¼Œè½‰å…¥é‡‘é¡é è¨­ç­‰æ–¼è½‰å‡ºé‡‘é¡
                account: document.getElementById('account').value,
                accountTo: document.getElementById('accountTo').value,
                category: currentType === 'è½‰å¸³' ? 'è½‰å¸³' : document.getElementById('category').value,
                subcategory: document.getElementById('subcategory').value,
                description: document.getElementById('description').value,
                type: currentType
            };

            if (!transaction.amount || !transaction.account) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            transactions.unshift(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
            closeModal();

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'addTransaction', transaction: transaction })
                });
            } catch (e) { console.error('åŒæ­¥å¤±æ•—', e); }
        }

        function updateUI() {
            let income = 0, expense = 0;
            const now = new Date();
            const balances = {};
            config.accounts.forEach(a => balances[a] = 0);

            transactions.forEach(t => {
                const amtOut = parseFloat(t.amount) || 0;
                const amtIn = parseFloat(t.amountTo) || amtOut; // å¦‚æœåŒ¯å…¥è³‡æ–™æ²’æœ‰ amountToï¼Œå‰‡é è¨­ç­‰æ–¼ amount
                const tDate = new Date(t.date);
                
                // é¤˜é¡èˆ‡æœˆåº¦çµ±è¨ˆè¨ˆç®—
                if (t.type === 'æ”¶å…¥') {
                    if (balances.hasOwnProperty(t.account)) balances[t.account] += amtOut;
                    if (tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear()) income += amtOut;
                } else if (t.type === 'æ”¯å‡º') {
                    if (balances.hasOwnProperty(t.account)) balances[t.account] -= amtOut;
                    if (tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear()) expense += amtOut;
                } else if (t.type === 'è½‰å¸³') {
                    // Money Pro è¨­è¨ˆï¼šæ‰£é™¤ A å¸³æˆ¶çš„ã€Œé‡‘é¡ã€ï¼Œå¢åŠ  B å¸³æˆ¶çš„ã€Œæ”¶åˆ°çš„é‡‘é¡ã€
                    if (balances.hasOwnProperty(t.account)) balances[t.account] -= amtOut;
                    if (balances.hasOwnProperty(t.accountTo)) balances[t.accountTo] += amtIn;
                }
            });

            document.getElementById('monthlyIncome').textContent = `NT$ ${income.toLocaleString()}`;
            document.getElementById('monthlyExpense').textContent = `NT$ ${expense.toLocaleString()}`;

            // æ›´æ–°ä»Šæ—¥äº¤æ˜“
            const todayStr = new Date().toISOString().split('T')[0];
            const listDiv = document.getElementById('todayTransactions');
            listDiv.innerHTML = '<h2>ä»Šæ—¥äº¤æ˜“</h2>';
            transactions.filter(t => t.date === todayStr).forEach(t => {
                listDiv.innerHTML += `<div class="transaction-item ${t.type === 'æ”¶å…¥' ? 'income' : 'expense'}">
                    <div><strong>${t.category}</strong><br><small>${t.account}${t.accountTo ? ' â” ' + t.accountTo : ''}</small></div>
                    <div style="font-weight:bold">${t.amount.toLocaleString()}</div>
                </div>`;
            });

            // æ›´æ–°é¤˜é¡åˆ—è¡¨
            const accListDiv = document.getElementById('accountList');
            accListDiv.innerHTML = '';
            config.accounts.forEach(acc => {
                accListDiv.innerHTML += `<div class="transaction-item"><span>${acc}</span><span style="font-weight:bold">NT$ ${(balances[acc] || 0).toLocaleString()}</span></div>`;
            });
        }
    </script>
</body>
</html>
